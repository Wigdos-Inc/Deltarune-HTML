<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <title>Deltarune</title>
</head>
<body>
  <div class="logo-container">
    <img src="logo.png" alt="Logo" class="logo">
  </div>
  <div class="menu" id="menu"></div>
  
  <audio id="drone" loop autoplay>
    <source src="audios/NGAHHH!!.ogg" type="audio/ogg">
    Your browser does not support the audio element.
  </audio>
  <script>
    // Configuration
    const CHAPTERS = [
      { number: 1, title: "The Beginning", available: true },
      { number: 2, title: "A Cyber's World", available: true },
      { number: 3, title: "Late Night", available: true },
      { number: 4, title: "Prophecy", available: true },
      { number: 5, title: "--", available: false },
      { number: 6, title: "--", available: false },
      { number: 7, title: "--", available: false }
    ];

    // State
    let gameStarted = false;
    let selectedChapter = null;

  // Audio elements
  const audio = document.getElementById('drone');
    const menuMoveAudio = new Audio('audios/snd_menumove.mp3');
    const menuSelectAudio = new Audio('audios/snd_select.mp3');

    // Initialize menu
    function initMenu() {
      const menu = document.getElementById('menu');
      
      CHAPTERS.forEach((chapter, index) => {
        const row = document.createElement('a');
        row.className = chapter.available ? 'row' : 'disabled-row';
        row.href = chapter.available 
          ? `javascript:loadChapter(${chapter.number})` 
          : `javascript:alert('Chapter ${chapter.number} coming soon!')`;
        
        row.innerHTML = `
          <span class="chapter">Chapter ${chapter.number}</span>
          <span class="${chapter.available ? 'title' : 'disabled-title'}">${chapter.title}</span>
          <img src="icons/${chapter.available ? chapter.number : 0}.png">
        `;
        
        menu.appendChild(row);
      });
    }

    // Audio control - Fixed to restart audio properly
    function restartAudio() {
      audio.currentTime = 0;
      audio.play().catch(err => {
        console.log('Audio play failed:', err);
        // If autoplay was blocked, resume on first user interaction
        const resume = () => {
          audio.play().catch(e => console.log('Audio resume failed:', e));
          window.removeEventListener('click', resume);
          window.removeEventListener('keydown', resume);
        };
        window.addEventListener('click', resume, { once: true });
        window.addEventListener('keydown', resume, { once: true });
      });
    }

    // Chapter loading â€” navigate to the chapter page to avoid path/relative URL issues
    function loadChapter(chapter) {
      // Mute background drone when actually loading a chapter
      audio.muted = true;
      // Perform a full navigation so the chapter's own <base> and scripts load correctly
      window.location.href = `chapter${chapter}/index.html`;
    }

    // Navigation
    function selectChapter(index) {
      const rows = document.querySelectorAll('.row');
      if (selectedChapter !== null) {
        rows[selectedChapter].classList.remove("selected");
      }
      selectedChapter = index;
      rows[selectedChapter].classList.add("selected");
      menuMoveAudio.play();
    }

    function navigateUp() {
      const rows = document.querySelectorAll('.row');
      if (selectedChapter === null) {
        selectChapter(0);
      } else {
        const newIndex = selectedChapter === 0 ? rows.length - 1 : selectedChapter - 1;
        selectChapter(newIndex);
      }
    }

    function navigateDown() {
      const rows = document.querySelectorAll('.row');
      if (selectedChapter === null) {
        selectChapter(0);
      } else {
        const newIndex = selectedChapter === rows.length - 1 ? 0 : selectedChapter + 1;
        selectChapter(newIndex);
      }
    }

    function activateSelected() {
      if (selectedChapter !== null) {
        const rows = document.querySelectorAll('.row');
        menuSelectAudio.play();
        window.location.href = rows[selectedChapter].href;
      }
    }

    // Event listeners
    document.addEventListener('keydown', (event) => {
      if (gameStarted) return;
      
      switch(event.key) {
        case 'ArrowUp':
          navigateUp();
          break;
        case 'ArrowDown':
          navigateDown();
          break;
        case 'Enter':
          activateSelected();
          break;
      }
    });

    // Mouse interactions
    function setupMouseEvents() {
      document.querySelectorAll('.row').forEach((row, index) => {
        row.addEventListener('mouseenter', () => {
          if (!gameStarted) {
            menuMoveAudio.play();
            if (selectedChapter !== null) {
              document.querySelectorAll('.row')[selectedChapter].classList.remove("selected");
            }
          }
        });
        
        row.addEventListener('click', () => {
          if (!gameStarted) {
            menuSelectAudio.play();
          }
        });
      });
    }

    // Handle page visibility changes to restart audio
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !gameStarted) {
        restartAudio();
      }
    });

    // Handle when returning from a chapter (page load)
    window.addEventListener('pageshow', (event) => {
      if (event.persisted || performance.navigation.type === 2) {
        // Page was restored from cache (back button)
        gameStarted = false;
        // Unmute background audio when returning to menu and try to restart it
        audio.muted = false;
        restartAudio();
      }
    });

    // Analytics
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-WLTG1S4STB');

  // Initialize
  initMenu();
  setupMouseEvents();
    
  // Try to play audio on load
  restartAudio();
  </script>
</body>
</html>