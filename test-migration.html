<!DOCTYPE html>
<html>
<head>
    <title>Save Data Migration Test</title>
</head>
<body>
    <h1>Deltarune Save Data Migration Test</h1>
    <div id="status">Loading...</div>
    <div id="log"></div>
    
    <button onclick="addTestData()">Add Test Data to localStorage</button>
    <button onclick="clearLocalStorage()">Clear localStorage</button>
    <button onclick="clearIndexedDB()">Clear IndexedDB</button>
    <button onclick="testMigration()">Test Migration</button>
    <button onclick="checkData()">Check Data</button>

    <script src="savedata-migration.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        
        function log(message) {
            console.log(message);
            logEl.innerHTML += '<div>' + message + '</div>';
        }
        
        function addTestData() {
            localStorage.setItem('deltarune_save_config.ini', 'test_config_data');
            localStorage.setItem('deltarune_save_dr.ini', 'test_save_data');
            localStorage.setItem('deltarune_save_system_information_1', 'system_info_data');
            log('Added test data to localStorage');
        }
        
        function clearLocalStorage() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('deltarune_save_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));
            log('Cleared deltarune save data from localStorage');
        }
        
        function clearIndexedDB() {
            const deleteReq = indexedDB.deleteDatabase('emscripten_filesystem');
            deleteReq.onsuccess = () => log('Cleared IndexedDB');
            deleteReq.onerror = () => log('Error clearing IndexedDB');
        }
        
        async function testMigration() {
            await window.checkAndMigrateSaveData();
            log('Migration test completed');
        }
        
        async function checkData() {
            // Check localStorage
            const localKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('deltarune_save_')) {
                    localKeys.push(key);
                }
            }
            log('LocalStorage keys: ' + localKeys.join(', '));
            
            // Check IndexedDB
            try {
                const request = indexedDB.open('emscripten_filesystem');
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['FILES'], 'readonly');
                    const objectStore = transaction.objectStore('FILES');
                    const files = [];
                    const cursor = objectStore.openCursor();
                    cursor.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.key.startsWith('/_savedata')) {
                                files.push(cursor.key);
                            }
                            cursor.continue();
                        } else {
                            log('IndexedDB files: ' + files.join(', '));
                            db.close();
                        }
                    };
                };
            } catch (error) {
                log('Error checking IndexedDB: ' + error);
            }
        }
        
        statusEl.textContent = 'Ready for testing';
    </script>
</body>
</html>